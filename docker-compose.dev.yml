version: "3.8"

# Simplified Docker Compose - Backend Services Only
# Run frontend locally with: pnpm dev

services:
  # MongoDB Service
  mongodb:
    image: mongo:7.0
    container_name: cybersec-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: gamification
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    command: ["--replSet", "rs0", "--bind_ip_all"]
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB Replica Set Initialization
  mongo-init:
    image: mongo:7.0
    container_name: mongo-init
    depends_on:
      mongodb:
        condition: service_healthy
    restart: "no"
    entrypoint: >
      mongosh --host mongodb:27017 --eval 
      'rs.initiate({
        _id: "rs0",
        members: [{ _id: 0, host: "mongodb:27017" }]
      })'

  # App Permission Service
  app-permission-service:
    build:
      context: ./app-permission-service
      dockerfile: Dockerfile
    container_name: app-permission-service
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - MONGO_URI=mongodb://mongodb:27017/gamification?replicaSet=rs0
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    volumes:
      - ./app-permission-service:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Phishing Detection Service
  phishing-detection-service:
    build:
      context: ./phishing-detection-service
      dockerfile: Dockerfile
    container_name: phishing-detection-service
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - HOST=0.0.0.0
      - PORT=8001
      - MONGO_URI=mongodb://mongodb:27017/gamification?replicaSet=rs0
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    volumes:
      - ./phishing-detection-service:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Password Security Service
  password-security-service:
    build:
      context: ./password-security-service
      dockerfile: Dockerfile
    container_name: password-security-service
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - HOST=0.0.0.0
      - PORT=8002
      - MONGO_URI=mongodb://mongodb:27017/gamification?replicaSet=rs0
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    volumes:
      - ./password-security-service:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Social Engineering Service
  social-engineering-service:
    build:
      context: ./social-engineering-service
      dockerfile: Dockerfile
    container_name: social-engineering-service
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - HOST=0.0.0.0
      - PORT=8003
      - MONGO_URI=mongodb://mongodb:27017/gamification?replicaSet=rs0
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    volumes:
      - ./social-engineering-service:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Safe Browsing Service
  safe-browsing-service:
    build:
      context: ./device-security-service
      dockerfile: Dockerfile
    container_name: safe-browsing-service
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - HOST=0.0.0.0
      - PORT=8004
      - MONGO_URI=mongodb://mongodb:27017/gamification?replicaSet=rs0
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    volumes:
      - ./device-security-service:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mongodb_data:
    driver: local

networks:
  default:
    name: cybersec-network
